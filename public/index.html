<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>지도 링크 변환기</title>
  <style>
    * { box-sizing: border-box; margin: 0; }

    body {
      background: #f5f5f5;
      color: #222;
      font-family: -apple-system, "Apple SD Gothic Neo", "Pretendard", system-ui, sans-serif;
      line-height: 1.5;
      -webkit-text-size-adjust: 100%;
    }

    .wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    h1 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .controls select,
    .controls input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.9rem;
      background: #fff;
      color: #222;
    }

    .controls input { max-width: 90px; }

    textarea {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font: 0.85rem/1.4 monospace;
      background: #fff;
      color: #222;
    }

    textarea:focus,
    .controls select:focus,
    .controls input:focus {
      outline: 2px solid #4a90d9;
      outline-offset: -1px;
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border: 0;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    button:active { opacity: 0.7; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .primary { background: #222; color: #fff; flex: 1; }
    .ghost { background: #e8e8e8; color: #444; }

    .status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #888;
      min-height: 20px;
    }
    .status.ok { color: #0d7a42; }
    .status.warn { color: #b65d00; }
    .status.bad { color: #c0392b; }

    .divider {
      border: 0;
      border-top: 1px solid #e0e0e0;
      margin: 16px 0;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-header h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .copy-btn {
      background: none;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.8rem;
      color: #555;
    }

    .resultbox {
      width: 100%;
      min-height: 120px;
      max-height: 300px;
      overflow: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
      font: 0.85rem/1.4 monospace;
      white-space: pre-wrap;
    }

    .tablewrap {
      margin-top: 10px;
      overflow-x: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      -webkit-overflow-scrolling: touch;
    }

    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 7px 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #fafafa;
      font-size: 0.75rem;
      color: #888;
      position: sticky;
      top: 0;
    }

    tr:last-child td { border-bottom: 0; }

    .pill {
      display: inline-block;
      border-radius: 4px;
      padding: 1px 6px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .pill.ok { color: #0d7a42; background: #e9f8ef; }
    .pill.bad { color: #c0392b; background: #fdecea; }

    .badge {
      display: inline-block;
      border-radius: 4px;
      font-size: 0.7rem;
      padding: 1px 6px;
      font-weight: 600;
    }
    .badge.pass { background: #e9f8ef; color: #0d7a42; }
    .badge.fail { background: #fff3e0; color: #e65100; }
    .badge.none { background: #f0f0f0; color: #999; }

    a { color: #4a90d9; text-decoration: none; word-break: break-all; }
    a:hover { text-decoration: underline; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>지도 링크 변환기</h1>

    <div class="controls">
      <select id="direction">
        <option value="naver_to_kakao">네이버 → 카카오</option>
        <option value="kakao_to_naver">카카오 → 네이버</option>
      </select>
      <input id="maxDistance" type="number" min="0" step="10" value="300" placeholder="거리(m)" />
    </div>

    <textarea id="input" spellcheck="false" placeholder="상호명&#10;주소&#10;https://naver.me/...&#10;&#10;상호명&#10;주소&#10;https://naver.me/..."></textarea>

    <div class="actions">
      <button class="primary" id="convertBtn">변환</button>
      <button class="ghost" id="clearBtn">초기화</button>
    </div>

    <div id="status" class="status"></div>

    <div id="resultSection" class="hidden">
      <hr class="divider" />

      <div class="result-header">
        <h2>결과</h2>
        <button class="copy-btn" id="copyBtn">복사</button>
      </div>

      <div id="resultText" class="resultbox"></div>

      <div class="tablewrap">
        <table id="resultTable">
          <thead>
            <tr>
              <th>#</th>
              <th>상태</th>
              <th>상호</th>
              <th>거리</th>
              <th>검증</th>
              <th>링크</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const inputEl = document.getElementById("input");
    const directionEl = document.getElementById("direction");
    const maxDistanceEl = document.getElementById("maxDistance");
    const statusEl = document.getElementById("status");
    const resultSection = document.getElementById("resultSection");
    const resultTextEl = document.getElementById("resultText");
    const resultTableBody = document.querySelector("#resultTable tbody");
    const convertBtn = document.getElementById("convertBtn");

    const clearBtn = document.getElementById("clearBtn");
    const copyBtn = document.getElementById("copyBtn");

    function setStatus(text, tone = "") {
      statusEl.textContent = text;
      statusEl.className = `status ${tone}`.trim();
    }

    function parseInput(raw) {
      const blocks = (raw || "")
        .split(/\n\s*\n+/)
        .map((b) => b.trim())
        .filter(Boolean);

      const entries = [];

      for (let i = 0; i < blocks.length; i += 1) {
        const lines = blocks[i]
          .split("\n")
          .map((line) => line.trim())
          .filter(Boolean)
          .filter((line) => !/^\[[^\]]+\]$/.test(line));

        const urlLines = lines.filter((line) => /^https?:\/\//i.test(line));
        const sourceUrl = urlLines[0] || "";
        const nonUrl = lines.filter((line) => !/^https?:\/\//i.test(line));

        // URL만 여러 줄로 들어온 경우, 각 URL을 개별 엔트리로 처리
        if (urlLines.length > 1 && nonUrl.length === 0) {
          for (let j = 0; j < urlLines.length; j += 1) {
            entries.push({
              index: entries.length + 1,
              name: "",
              address: "",
              sourceUrl: urlLines[j],
              rawBlock: urlLines[j],
            });
          }
          continue;
        }

        const name = nonUrl[0] || "";
        const address = nonUrl.slice(1).join(" ").trim();

        if (!name && !address && !sourceUrl) continue;

        entries.push({
          index: i + 1,
          name,
          address,
          sourceUrl,
          rawBlock: blocks[i],
        });
      }

      return entries;
    }

    function getTargetLabel(direction) {
      return direction === "naver_to_kakao" ? "[카카오맵]" : "[네이버지도]";
    }

    function escapeHtml(v) {
      return String(v)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function badgeForDistancePass(distancePass) {
      if (distancePass === true) return '<span class="badge pass">통과</span>';
      if (distancePass === false) return '<span class="badge fail">불통과</span>';
      return '<span class="badge none">미측정</span>';
    }

    function renderResults(results, direction) {
      const textBlocks = [];
      const rows = [];
      const targetLabel = getTargetLabel(direction);

      for (const item of results) {
        if (item.ok) {
          textBlocks.push(
            [targetLabel, item.targetName, item.targetAddress || "", item.targetUrl].join("\n")
          );

          const distanceText = Number.isFinite(item.distanceMeters)
            ? String(item.distanceMeters)
            : "-";

          rows.push(`
            <tr>
              <td>${item.source.index}</td>
              <td><span class="pill ok">성공</span></td>
              <td>${escapeHtml(item.source.name || "(없음)")}</td>
              <td>${distanceText}</td>
              <td>${badgeForDistancePass(item.distancePass)}</td>
              <td><a href="${escapeHtml(item.targetUrl)}" target="_blank" rel="noopener">${escapeHtml(item.targetUrl)}</a></td>
            </tr>
          `);
        } else {
          textBlocks.push(
            [targetLabel, item.source.name || "(없음)", item.source.address || "", `실패: ${item.error}`].join("\n")
          );

          rows.push(`
            <tr>
              <td>${item.source.index}</td>
              <td><span class="pill bad">실패</span></td>
              <td>${escapeHtml(item.source.name || "(없음)")}</td>
              <td>-</td>
              <td>${badgeForDistancePass(null)}</td>
              <td>-</td>
            </tr>
          `);
        }
      }

      resultTextEl.textContent = textBlocks.join("\n\n");
      resultTableBody.innerHTML = rows.join("");
      resultSection.classList.remove("hidden");
    }

    async function callConvertApi(payload) {
      const res = await fetch("/api/convert", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data || !Array.isArray(data.results)) {
        const message = data && data.error ? data.error : `API 오류 (${res.status})`;
        throw new Error(message);
      }
      return data;
    }

    async function convertAll() {
      const entries = parseInput(inputEl.value);
      const direction = directionEl.value;
      const maxDistanceMeters = Number(maxDistanceEl.value) || 300;

      if (entries.length === 0) {
        setStatus("입력 내용을 확인해주세요.", "bad");
        resultSection.classList.add("hidden");
        return;
      }

      convertBtn.disabled = true;

      clearBtn.disabled = true;
      copyBtn.disabled = true;

      try {
        setStatus(`변환 중... (${entries.length}건)`);
        const data = await callConvertApi({ direction, entries, maxDistanceMeters });
        renderResults(data.results, direction);

        const successCount = data.results.filter((r) => r.ok).length;
        const failCount = data.results.length - successCount;

        if (failCount === 0) {
          setStatus(`${successCount}건 변환 완료`, "ok");
        } else if (successCount > 0) {
          setStatus(`성공 ${successCount}건, 실패 ${failCount}건`, "warn");
        } else {
          setStatus(`${failCount}건 실패`, "bad");
        }
      } catch (err) {
        setStatus(err instanceof Error ? err.message : String(err), "bad");
      } finally {
        convertBtn.disabled = false;

        clearBtn.disabled = false;
        copyBtn.disabled = false;
      }
    }

    clearBtn.addEventListener("click", () => {
      inputEl.value = "";
      resultTextEl.textContent = "";
      resultTableBody.innerHTML = "";
      resultSection.classList.add("hidden");
      setStatus("");
    });

    convertBtn.addEventListener("click", convertAll);

    copyBtn.addEventListener("click", async () => {
      const text = resultTextEl.textContent.trim();
      if (!text) {
        setStatus("복사할 결과가 없습니다.", "warn");
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        setStatus("복사됨", "ok");
      } catch (_err) {
        setStatus("복사 실패", "bad");
      }
    });
  </script>
</body>
</html>
